if (POLICY CMP0048)
    cmake_policy(SET CMP0048 NEW)
endif (POLICY CMP0048)

project(ConanWrapper VERSION 1.0.0 LANGUAGES C)

set(CMAKE_VERBOSE_MAKEFILE ON)

# Set a default build type if none was specified
if(NOT CMAKE_BUILD_TYPE AND NOT CMAKE_CONFIGURATION_TYPES)
  message(STATUS "Setting build type to 'Release' as none was specified.")
  set(CMAKE_BUILD_TYPE Release CACHE STRING "Choose the type of build." FORCE)
  # Set the possible values of build type for cmake-gui
  set_property(CACHE CMAKE_BUILD_TYPE PROPERTY STRINGS "Debug" "Release" "MinSizeRel" "RelWithDebInfo")
endif()

set(LIBZIPARCHIVE_ROOT ${CMAKE_CURRENT_SOURCE_DIR}/../)

# Require out-of-source builds
file(TO_CMAKE_PATH "${PROJECT_BINARY_DIR}/CMakeLists.txt" LOC_PATH)
if(EXISTS "${LOC_PATH}")
    message(FATAL_ERROR "You cannot build in a source directory (or any directory with a CMakeLists.txt file). Please make a build subdirectory. Feel free to remove CMakeCache.txt and CMakeFiles.")
endif()

if(NOT EXISTS "${CMAKE_BINARY_DIR}/conan.cmake")
    message(STATUS "Downloading conan.cmake from https://github.com/conan-io/cmake-conan")
    file(DOWNLOAD "https://raw.githubusercontent.com/conan-io/cmake-conan/0.18.1/conan.cmake"
            "${CMAKE_BINARY_DIR}/conan.cmake"
            TLS_VERIFY ON)
endif()
include(${CMAKE_BINARY_DIR}/conan.cmake)

conan_cmake_autodetect(settings)
conan_cmake_install(PATH_OR_REFERENCE ${LIBZIPARCHIVE_ROOT}/cmake
                    PROFILE_HOST ${LIBZIPARCHIVE_ROOT}/cmake/armv8.profile
                    PROFILE_BUILD ${LIBZIPARCHIVE_ROOT}/cmake/build.profile
                    BUILD missing)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_BINARY_DIR})

# Set conan environment variables generated using the virtualenv generator
# This is necessary since for some reason Conan does not correctly set the variables found (e.g. the Android NDK compiler path)
# A particular attention should be paid to the PATH variable since it is not good to completely overwrite it
if(EXISTS "${CMAKE_BINARY_DIR}/environment.sh.env")
    FILE(READ "${CMAKE_BINARY_DIR}/environment.sh.env" _contents)
    STRING(REGEX REPLACE "\n" ";" _contents "${_contents}")
    foreach(_line ${_contents})
        string(REGEX MATCH "([^=]+)=\"(.*)\"" _match ${_line})
        if(NOT "${_match}" STREQUAL "" AND NOT "${CMAKE_MATCH_1}" STREQUAL "PATH")
            #message("in ${CMAKE_MATCH_1} = ${CMAKE_MATCH_2}")
            set(ENV{${CMAKE_MATCH_1}} "${CMAKE_MATCH_2}")
        endif()
    endforeach()
    unset(_contents)
    unset(_line)
    unset(_match)
else()
    message(FATAL_ERROR "Android NDK environment variables not found!")
endif()

set(CMAKE_C_COMPILER   $ENV{CC})
set(CMAKE_CXX_COMPILER $ENV{CXX})
set(CMAKE_CXX_COMPILER_AR $ENV{AR})
set(CMAKE_CXX_COMPILER_RANLIB $ENV{RANLIB})
set(CMAKE_AR           $ENV{AR})
set(CMAKE_AS           $ENV{AS})
set(CMAKE_RANLIB       $ENV{RANLIB})
set(CMAKE_STRIP        $ENV{STRIP})
set(CMAKE_ADDR2LINE    $ENV{ADDR2LINE})
set(CMAKE_NM           $ENV{NM})
set(CMAKE_OBJCOPY      $ENV{OBJCOPY})
set(CMAKE_OBJDUMP      $ENV{OBJDUMP})
set(CMAKE_READELF      $ENV{READELF})
set(CMAKE_LD           $ENV{LD})
